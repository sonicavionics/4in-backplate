name: Export KiCad Images

on:
  push:
    paths:
      - '**/*.kicad_sch'
      - '**/*.kicad_pcb'
  workflow_dispatch:

jobs:
  export-kicad-files:
    runs-on: ubuntu-latest

    steps:
    # Checkout the repository
    - name: Checkout repository
      uses: actions/checkout@v3

    # Set permissions for the workspace directory
    - name: Set workspace folder permissions
      run: chmod -R 777 ${{ github.workspace }}

    # Pull KiCad Docker image
    - name: Pull KiCad Docker image
      run: |
        echo "Pulling KiCad Docker image..."
        docker pull kicad/kicad:8.0

    - name: Export schematic, PCB, and 3D model
      run: |
        echo "Exporting schematic, PCB, and 3D model..."
        docker run --rm -v "${{ github.workspace }}:/workspace" -w /workspace kicad/kicad:8.0 bash -c "
          set -e
          
          mkdir -p images
          
          # Export schematic
          echo 'Exporting schematic...'
          kicad-cli sch export svg -o 'images/sch' kicad/*.kicad_sch || echo 'Schematic export failed!'
          mv images/sch/*.svg images/sch.svg || echo 'Schematic SVG move failed!'
          rm -r images/sch || echo 'Failed to remove temporary schematic directory.'

          # Export PCB
          echo 'Exporting PCB...'
          kicad-cli pcb export svg -o 'images/pcb.svg' --page-size-mode 2 --exclude-drawing-sheet --layers 'F.Cu,F.SilkS,F.Mask' kicad/*.kicad_pcb || echo 'PCB export failed!'

          # Export 3D model
          echo 'Exporting 3D model...'
          kicad-cli pcb export vrml --output 'images/board.wrl' kicad/*.kicad_pcb || echo '3D model export failed!'

          # Add lighting effects to VRML file
          echo 'Modifying VRML file for lighting...'
          cd /workspace/images
          if [ -f 'board.wrl' ]; then
          head -1 'board.wrl' > 'board.front.wrl'
          cat <<EOF >> 'board.front.wrl'
        Transform {
            children [
              DirectionalLight {
                  on TRUE
                  intensity 0.63
                  ambientIntensity 0.21
                  color 1.0 1.0 1.0
                  direction 0.1 -0.1 -1
              }
        EOF
          cat 'board.wrl' >> 'board.front.wrl'
          echo '] }' >> 'board.front.wrl'

          # Convert to PNG using Rayhunter
          echo 'Converting to PNG with Rayhunter...'
          rayhunter classic 7 \
              4320 4320 \
              'board.front.wrl' \
              'board.png' \
              --camera-pos 0 0 6 \
              --camera-dir 0 0 -1 \
              --scene-bg-color 1 1 1 || echo 'Rayhunter conversion failed!'
          else
            echo 'VRML file not found, skipping Rayhunter conversion.'
          fi
        "


    # Debug workspace contents
    - name: Debug - List workspace contents
      run: ls -R ${{ github.workspace }}

    # Debug image directory contents
    - name: Debug - List images directory contents
      run: ls -R ${{ github.workspace }}/images

    # Commit and push the changes
    - name: Commit and push changes
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        if git status --porcelain | grep 'images/'; then
          git add images/*
          git commit -m "Auto-exported schematic, PCB, and 3D model"
          git push
        else
          echo "No changes detected, skipping commit."
        fi

    # Notify the user about completion
    - name: Notify completion
      run: echo "3D model image export process completed."
